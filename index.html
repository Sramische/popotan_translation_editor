<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Popotan editor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css">
    
    <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/dropbox.js/0.10.2/dropbox.min.js"></script>
    <script src="jstree/jstree.min.js"></script>
    <script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="api.js"></script>
  </head>

	<body>
    <div id="header_pane">
      <div class="spinner" style="position:relative;float:left;display:none;">
        <div class="bounce1"></div>
        <div class="bounce2"></div>
        <div class="bounce3"></div>
      </div>
      <button id="btn_file_browser" class="btn" type="button" style="margin-top:3px;margin-left:5px;float:left;">Open file tree</button>
      <button id="btn_save" class="btn btn-success" type="button" style="margin-top:3px;margin-left:10px;float:left;display:none;">Save</button>
      
      <a href="#" class="btn-text" id="signin" style="color: #008bd3;">
         <img src="img/dropbox32x32.png" style="margin-right:5px;"/>
         <span id="signin-text">error</span>
      </a>
		</div>
    
    <div id="red_block" class="btn-text" style="color:#333;display:none;" ></div>
    <div id="editor" style="display:none;"></div>
    <div id="file_tree"></div>

		<script>

      /*----------------ace init--------------*/
      
      var editor = ace.edit("editor");
			editor.getSession().setNewLineMode("windows")
			editor.setDisplayIndentGuides(false)
			editor.setBehavioursEnabled(false)
			editor.setShowPrintMargin(false)
			editor.setFontSize(14)
			editor.setShowInvisibles(false);
			editor.commands.removeCommand('find');
      var ps = new Script(editor);

			//editor.session.selection.on("changeCursor", function(){}); 
      
      /*-------------jstree init--------------*/
      
      var tree = new CssTree("file_tree");
      tree.setOnFileClickListener(function(parent, path){
        if(path == api.getLastFile()){
          openFile(null);
          return;
        }
        
        showProgress(true);
        api.openFile(path, function(contents){
          if (typeof contents === 'string'){
            openFile(contents);
          } else {
            showError("Dropbox said : " + contents.response.error);
          }
          showProgress(false);
        });
      }).setOnFolderExpandingListener(function(path){
        showProgress(true);
        api.openDir(path, ["text/plain", "inode/directory"], function(arr){
          showProgress(false);
          if (arr.length == 0)
            tree.markEmpty();
          else  
            populateBranch(arr);
        });
      });
			
      /*------------api init------------------*/
      
      var api = new DropboxApi();
      api.setOnAuthListener(function(isSignedIn){
        if(typeof isSignedIn != "boolean") {
          showError(isSignedIn);
          return;
        }
        
        $("#signin-text").text(isSignedIn ? "Sign out" : "Sign in");
        showButtons(isSignedIn);
        
        if(!isSignedIn)
          return;
          
        path = api.getLastFile();
        if(path){
          showProgress(true);
          api.openFile(path, function(contents){
            if (typeof contents === 'string')
              openFile(contents);
            else {
              populateTree();
              showError("Dropbox said : " + contents.response.error);
            }
          });
        } else {
          populateTree();
        }
      });
      
      /*--------------Click handlers--------*/
      
      function onSaveClick(){
        clearError();
				$("#btn_save").text("Validating...");
        content = editor.getValue();
        result = ps.validateScript(content);

        if (typeof result === 'boolean'){
          showProgress(true);
          $("#btn_save").text("Saving...");
          toggleSaveBtn(false);
          api.savePatches(ps.getPatches(), function(patchresult){
            console.log("PATCHES SAVED");
            if(patchresult == null){
              api.save(content, function(saveresult){
                console.log("SCRIPT SAVED");
                if(saveresult instanceof Dropbox.ApiError){
                  showError("Dropbox said: " + saveresult.response.error);
                }else if(typeof(saveresult) === 'string'){
                  showError(saveresult);
                }else if (saveresult == null){
                  $("#btn_save").hide();
                }
                toggleSaveBtn(true);
                $("#btn_save").text("Save");
                showProgress(false);
              });
              
            } else if(patchresult instanceof Dropbox.ApiError){
              showError("Dropbox said: " + result.response.error);
              showProgress(false);
            }
          });
          
        } else {
          editor.gotoLine(result.line, 0, true);
          showError("On line " + result.line + " unexpected token: '" + result.got + "'");
          $("#btn_save").text("Save");
        }
      }
      
			$("#signin").click(function(){
        if (api.isAuthenticated()){
          api.signOut();
          window.location.reload();
        }
        else
          api.signIn();
      });
      
      $("#btn_file_browser").click(function(){
        $("#editor").hide();
        $("#file_tree").show();
        $("#btn_save").hide();
        if(tree.isEmpty())
          populateTree();
          
      });
  
      toggleSaveBtn(true);
      
      /*--------------Util funcs--------*/
      
      function openFile(contents){
        $("#file_tree").hide();
        $("#editor").show();
        if(contents != null){
          editor.session.on("change", function(){});
          editor.setValue(contents, -1);
          editor.session.on("change", function(delta){
            $("#btn_save").show();
            ps.onTextChanged(delta.data);
          });
          showProgress(false);
        }
      }
      
      function showError(message){
        $("#red_block").text(message);
        $("#red_block").show();
        $("#red_block").click(clearError);
        toggleSaveBtn(true);
      }
			
      function clearError(){
        $("#red_block").hide();
        $("#red_block").text('');
      }
      
      function showProgress(show){
        if (show)
          $(".spinner").show();
        else
          $(".spinner").hide();
      }
      
      function toggleSaveBtn(enable){
        if(enable){
          $("#btn_save").removeClass("disabled");
          $("#btn_save").click(onSaveClick);
        } else {
          $("#btn_save").addClass("disabled");
          $("#btn_save").unbind();
        }
      }
      
      function showButtons(show){
         if (show){
          $("#btn_file_browser").show();
        }
        else{
          $("#btn_file_browser").hide();
        }
      }
      
      function populateBranch(arr){
        arr.forEach(function(fstat){
          if (fstat.mimeType == "inode/directory")
            tree.addFolder(fstat.name, fstat.path);
          else
            tree.addFile(fstat.name, fstat.path);
        });
        tree.removeCallback();
        showProgress(false);
      }
      
      function populateTree(){
        showProgress(true);
        api.openDir(null, ["text/plain", "inode/directory"], populateBranch);
      }

		</script>
	</body>
</html>
